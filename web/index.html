<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Quest - å°å­¦ç”Ÿä½œä¸šç§¯åˆ†ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --accent-color: #FFC107;
            --danger-color: #f44336;
            --text-color: #333;
            --bg-color: #f5f5f5;
            --card-bg: #fff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container {
            width: 90%;
            max-width: 800px;
            margin: 20px auto;
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .role-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .role-btn {
            padding: 10px 30px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1.1rem;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .role-btn.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .points-display {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin: 10px 0;
        }

        .task-list {
            list-style: none;
            padding: 0;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
        }

        .task-points {
            color: var(--primary-color);
            font-weight: bold;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-approved { background-color: #d4edda; color: #155724; }
        .status-todo { background-color: #e2e3e5; color: #383d41; }

        .hidden { display: none !important; }

        input, select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        /* Login/Register styles */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-toggle {
            text-align: center;
            margin-top: 15px;
            color: var(--secondary-color);
            cursor: pointer;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .logout-btn {
            background: var(--danger-color);
            color: white;
            padding: 5px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .ranking-number {
            font-size: 1.5rem;
            font-weight: bold;
            width: 40px;
            text-align: center;
        }

        .ranking-number.top1 { color: gold; }
        .ranking-number.top2 { color: silver; }
        .ranking-number.top3 { color: #CD7F32; }

        .ranking-info {
            flex: 1;
            margin-left: 15px;
        }

        .ranking-points {
            font-weight: bold;
            color: var(--accent-color);
        }
    </style>
</head>
<body>

<header>
    <h1>Study Quest ğŸ“š</h1>
</header>

<!-- Auth View (Login/Register) -->
<div id="auth-view" class="auth-container">
    <div class="card">
        <h2 id="auth-title">ç™»å½•</h2>
        <div id="login-form">
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="login-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="login()">ç™»å½•</button>
            <p class="form-toggle" onclick="showRegisterForm()">æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ</p>
        </div>

        <div id="register-form" class="hidden">
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="register-username" placeholder="è‡³å°‘3ä¸ªå­—ç¬¦">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="register-password" placeholder="è‡³å°‘6ä¸ªå­—ç¬¦">
            </div>
            <div class="form-group">
                <label>çœŸå®å§“å</label>
                <input type="text" id="register-realname" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
            </div>
            <div class="form-group">
                <label>è§’è‰²</label>
                <select id="register-role" onchange="toggleGradeField()">
                    <option value="student">å­¦ç”Ÿ</option>
                    <option value="parent">å®¶é•¿</option>
                </select>
            </div>
            <div class="form-group" id="grade-field">
                <label>å¹´çº§</label>
                <select id="register-grade">
                    <option value="1">ä¸€å¹´çº§</option>
                    <option value="2">äºŒå¹´çº§</option>
                    <option value="3">ä¸‰å¹´çº§</option>
                    <option value="4">å››å¹´çº§</option>
                    <option value="5">äº”å¹´çº§</option>
                    <option value="6">å…­å¹´çº§</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="register()">æ³¨å†Œ</button>
            <p class="form-toggle" onclick="showLoginForm()">å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»å½•</p>
        </div>
    </div>
</div>

<!-- Main App View -->
<div id="app-view" class="hidden container">
    <div class="user-info">
        <div>
            <strong id="user-display"></strong>
            <span id="role-display"></span>
        </div>
        <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>

    <div class="role-switcher">
        <button class="role-btn active" onclick="switchView('student', event)">å­¦ç”Ÿç«¯ ğŸ‘¦</button>
        <button class="role-btn" onclick="switchView('parent', event)">å®¶é•¿ç«¯ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</button>
        <button class="role-btn" onclick="switchView('ranking', event)">æ’è¡Œæ¦œ ğŸ†</button>
    </div>

    <!-- Student View -->
    <div id="student-view">
        <div class="card">
            <h2>æˆ‘çš„ç§¯åˆ† ğŸŒŸ</h2>
            <div class="points-display" id="student-points">0</div>
        </div>

        <div class="card">
            <h2>ä»Šæ—¥ä»»åŠ¡ ğŸ“</h2>
            <ul class="task-list" id="student-task-list"></ul>
        </div>

        <div class="card">
            <h2>ç§¯åˆ†å…‘æ¢ ğŸ</h2>
            <ul class="task-list" id="reward-list"></ul>
        </div>
    </div>

    <!-- Parent View -->
    <div id="parent-view" class="hidden">
        <div class="card">
            <h2>å¾…å®¡æ ¸ä»»åŠ¡ âœ…</h2>
            <ul class="task-list" id="parent-audit-list"></ul>
        </div>

        <div class="card">
            <h2>å‘å¸ƒæ–°ä»»åŠ¡ â•</h2>
            <input type="text" id="new-task-title" placeholder="ä»»åŠ¡åç§° (ä¾‹å¦‚: å®Œæˆæ•°å­¦å·å­)">
            <input type="number" id="new-task-points" placeholder="ç§¯åˆ†å€¼ (ä¾‹å¦‚: 50)">
            <button class="btn btn-primary" onclick="createTask()">å‘å¸ƒä»»åŠ¡</button>
        </div>

        <div class="card">
            <h2>å®¶åº­æˆå‘˜ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</h2>
            <ul class="task-list" id="student-list"></ul>
        </div>
    </div>

    <!-- Ranking View -->
    <div id="ranking-view" class="hidden">
        <div class="card">
            <h2>ç§¯åˆ†æ’è¡Œæ¦œ ğŸ†</h2>
            <div id="ranking-list"></div>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api/v1';
    let currentView = 'student';
    let authToken = localStorage.getItem('auth_token');
    let currentUser = null;

    // Initialize
    if (authToken) {
        validateAndLoadApp();
    } else {
        showAuthView();
    }

    function showAuthView() {
        document.getElementById('auth-view').classList.remove('hidden');
        document.getElementById('app-view').classList.add('hidden');
    }

    function showAppView() {
        document.getElementById('auth-view').classList.add('hidden');
        document.getElementById('app-view').classList.remove('hidden');
    }

    function showLoginForm() {
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('auth-title').innerText = 'ç™»å½•';
    }
    window.showLoginForm = showLoginForm;

    function showRegisterForm() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.remove('hidden');
        document.getElementById('auth-title').innerText = 'æ³¨å†Œ';
    }
    window.showRegisterForm = showRegisterForm;

    function toggleGradeField() {
        const role = document.getElementById('register-role').value;
        const gradeField = document.getElementById('grade-field');
        gradeField.style.display = role === 'student' ? 'block' : 'none';
    }
    window.toggleGradeField = toggleGradeField;

    async function register() {
        const username = document.getElementById('register-username').value;
        const password = document.getElementById('register-password').value;
        const realName = document.getElementById('register-realname').value;
        const role = document.getElementById('register-role').value;
        const grade = parseInt(document.getElementById('register-grade').value);

        if (!username || !password || !realName) {
            alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/auth/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password, role, real_name: realName, grade})
            });

            const data = await response.json();
            if (response.ok) {
                alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
                showLoginForm();
            } else {
                alert(data.error || 'æ³¨å†Œå¤±è´¥');
            }
        } catch (e) {
            console.error('Register failed', e);
            alert('æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    async function login() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;

        if (!username || !password) {
            alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password})
            });

            const data = await response.json();
            if (response.ok) {
                authToken = data.token;
                currentUser = data.user;
                localStorage.setItem('auth_token', authToken);
                showAppView();
                updateUserDisplay();
                loadData();
            } else {
                alert(data.error || 'ç™»å½•å¤±è´¥');
            }
        } catch (e) {
            console.error('Login failed', e);
            alert('ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    async function logout() {
        try {
            await fetch(`${API_BASE}/auth/logout`, {
                method: 'POST',
                headers: {'Authorization': authToken}
            });
        } catch (e) {
            console.error('Logout failed', e);
        }

        authToken = null;
        currentUser = null;
        localStorage.removeItem('auth_token');
        showAuthView();
    }

    async function validateAndLoadApp() {
        try {
            const response = await fetch(`${API_BASE}/profile`, {
                headers: {'Authorization': authToken}
            });

            if (response.ok) {
                currentUser = await response.json();
                showAppView();
                updateUserDisplay();
                loadData();
            } else {
                authToken = null;
                localStorage.removeItem('auth_token');
                showAuthView();
            }
        } catch (e) {
            console.error('Validation failed', e);
            showAuthView();
        }
    }

    function updateUserDisplay() {
        document.getElementById('user-display').innerText = currentUser.real_name || currentUser.username;
        document.getElementById('role-display').innerText = currentUser.role === 'student' ? '(å­¦ç”Ÿ)' : '(å®¶é•¿)';
    }

    function switchView(view, event) {
        currentView = view;
        document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        document.getElementById('student-view').classList.toggle('hidden', view !== 'student');
        document.getElementById('parent-view').classList.toggle('hidden', view !== 'parent');
        document.getElementById('ranking-view').classList.toggle('hidden', view !== 'ranking');

        loadData();
    }

    function loadData() {
        if (currentView === 'student') {
            loadStudentData();
        } else if (currentView === 'parent') {
            loadParentData();
        } else if (currentView === 'ranking') {
            loadRanking();
        }
    }

    async function loadStudentData() {
        try {
            const profileRes = await fetch(`${API_BASE}/profile`, {
                headers: {'Authorization': authToken}
            });
            const profile = await profileRes.json();
            document.getElementById('student-points').innerText = profile.points;

            const tasksRes = await fetch(`${API_BASE}/tasks/today`, {
                headers: {'Authorization': authToken}
            });
            const tasks = await tasksRes.json();
            renderStudentTasks(tasks);

            renderRewards([
                {id: 1, title: 'çœ‹ç”µè§† 30åˆ†é’Ÿ', cost: 50},
                {id: 2, title: 'ç©æ‰‹æœº 15åˆ†é’Ÿ', cost: 30}
            ]);
        } catch (e) {
            console.error("Failed to load data", e);
        }
    }

    async function loadParentData() {
        try {
            const res = await fetch(`${API_BASE}/tasks/pending`, {
                headers: {'Authorization': authToken}
            });
            const tasks = await res.json();
            renderParentAuditList(tasks);

            const studentsRes = await fetch(`${API_BASE}/students`, {
                headers: {'Authorization': authToken}
            });
            const students = await studentsRes.json();
            renderStudentList(students);
        } catch (e) {
            console.error("Failed to load parent data", e);
        }
    }

    async function loadRanking() {
        try {
            const res = await fetch(`${API_BASE}/ranking`);
            const students = await res.json();
            renderRanking(students);
        } catch (e) {
            console.error("Failed to load ranking", e);
        }
    }

    function renderStudentTasks(tasks) {
        const list = document.getElementById('student-task-list');
        list.innerHTML = '';
        if (!tasks || tasks.length === 0) {
            list.innerHTML = '<li class="task-item">æš‚æ— ä»»åŠ¡</li>';
            return;
        }
        
        tasks.forEach(task => {
            console.log('Rendering task:', task); // Debug
            
            const li = document.createElement('li');
            li.className = 'task-item';
            
            // å®‰å…¨è·å–ä»»åŠ¡ä¿¡æ¯
            const taskTitle = task.task?.title || task.Task?.title || 'æœªçŸ¥ä»»åŠ¡';
            const taskPoints = task.task?.points || task.Task?.points || 0;
            const taskId = task.ID || task.id;
            
            let actionBtn = '';
            if (task.status === 0) {
                actionBtn = `<button class="btn btn-primary" onclick="window.submitTask(${taskId})">æäº¤å®Œæˆ</button>`;
            } else if (task.status === 1) {
                actionBtn = `<span class="status-badge status-pending">å®¡æ ¸ä¸­...</span>`;
            } else if (task.status === 2) {
                actionBtn = `<span class="status-badge status-approved">å·²å®Œæˆ</span>`;
            }

            li.innerHTML = `
                <div class="task-info">
                    <h3>${taskTitle}</h3>
                    <span class="task-points">+${taskPoints} ç§¯åˆ†</span>
                </div>
                <div>${actionBtn}</div>
            `;
            list.appendChild(li);
        });
    }

    function renderRewards(rewards) {
        const list = document.getElementById('reward-list');
        list.innerHTML = '';
        rewards.forEach(item => {
            const li = document.createElement('li');
            li.className = 'task-item';
            li.innerHTML = `
                <div class="task-info">
                    <h3>${item.title}</h3>
                    <span class="task-points" style="color:orange">-${item.cost} ç§¯åˆ†</span>
                </div>
                <button class="btn btn-success" onclick="redeem(${item.id}, ${item.cost})">å…‘æ¢</button>
            `;
            list.appendChild(li);
        });
    }

    function renderParentAuditList(tasks) {
        const list = document.getElementById('parent-audit-list');
        list.innerHTML = '';
        if (!tasks || tasks.length === 0) {
            list.innerHTML = '<li class="task-item">æš‚æ— å¾…å®¡æ ¸ä»»åŠ¡</li>';
            return;
        }
        tasks.forEach(task => {
            const li = document.createElement('li');
            li.className = 'task-item';
            li.innerHTML = `
                <div class="task-info">
                    <h3>${task.task.title}</h3>
                    <span class="task-points">å¾…å‘: ${task.task.points} ç§¯åˆ†</span>
                </div>
                <div>
                    <button class="btn btn-success" onclick="approveTask(${task.ID}, true)">é€šè¿‡</button>
                    <button class="btn btn-danger" onclick="approveTask(${task.ID}, false)">é©³å›</button>
                </div>
            `;
            list.appendChild(li);
        });
    }

    function renderStudentList(students) {
        const list = document.getElementById('student-list');
        list.innerHTML = '';
        if (!students || students.length === 0) {
            list.innerHTML = '<li class="task-item">æš‚æ— å®¶åº­æˆå‘˜</li>';
            return;
        }
        students.forEach(student => {
            const li = document.createElement('li');
            li.className = 'task-item';
            li.innerHTML = `
                <div class="task-info">
                    <h3>${student.real_name} (${student.username})</h3>
                    <span>å¹´çº§: ${student.grade}</span>
                </div>
                <div class="ranking-points">${student.points} ç§¯åˆ†</div>
            `;
            list.appendChild(li);
        });
    }

    function renderRanking(students) {
        const container = document.getElementById('ranking-list');
        container.innerHTML = '';
        if (!students || students.length === 0) {
            container.innerHTML = '<div class="task-item">æš‚æ— æ’åæ•°æ®</div>';
            return;
        }
        students.forEach((student, index) => {
            const div = document.createElement('div');
            div.className = 'ranking-item';
            
            let rankClass = '';
            if (index === 0) rankClass = 'top1';
            else if (index === 1) rankClass = 'top2';
            else if (index === 2) rankClass = 'top3';
            
            div.innerHTML = `
                <div class="ranking-number ${rankClass}">${index + 1}</div>
                <div class="ranking-info">
                    <h3>${student.real_name} (${student.username})</h3>
                    <span>å¹´çº§: ${student.grade}</span>
                </div>
                <div class="ranking-points">${student.points} ç§¯åˆ†</div>
            `;
            container.appendChild(div);
        });
    }

    async function submitTask(taskId) {
        console.log('Submitting task:', taskId);
        try {
            const response = await fetch(`${API_BASE}/tasks/submit`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': authToken},
                body: JSON.stringify({task_id: taskId})
            });
            
            if (response.ok) {
                alert('ä»»åŠ¡å·²æäº¤ï¼Œç­‰å¾…å®¶é•¿å®¡æ ¸');
                loadStudentData();
            } else {
                alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (e) {
            console.error('Submit failed', e);
            alert('æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        }
    }
    
    // å°†å‡½æ•°æŒ‚è½½åˆ° window å¯¹è±¡ï¼Œä»¥ä¾¿ onclick å¯ä»¥è®¿é—®
    window.submitTask = submitTask;

    async function approveTask(logId, approved) {
        await fetch(`${API_BASE}/tasks/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': authToken},
            body: JSON.stringify({log_id: logId, action: approved ? 'approve' : 'reject'})
        });
        loadParentData();
    }
    window.approveTask = approveTask;

    async function createTask() {
        const title = document.getElementById('new-task-title').value;
        const points = parseInt(document.getElementById('new-task-points').value);
        if (!title || !points) return alert('è¯·å¡«å†™å®Œæ•´');

        await fetch(`${API_BASE}/tasks/create`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': authToken},
            body: JSON.stringify({title, points})
        });
        alert('å‘å¸ƒæˆåŠŸ');
        document.getElementById('new-task-title').value = '';
        document.getElementById('new-task-points').value = '';
    }
    window.createTask = createTask;

    async function redeem(id, cost) {
        try {
            const response = await fetch(`${API_BASE}/rewards/redeem`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': authToken},
                body: JSON.stringify({reward_id: id, cost: cost})
            });
            
            if (response.ok) {
                alert('å…‘æ¢æˆåŠŸï¼è¯·æ‰¾å®¶é•¿é¢†å–å¥–åŠ±ã€‚');
                loadStudentData();
            } else {
                alert('ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•å…‘æ¢ï¼');
            }
        } catch (e) {
            console.error('Redeem failed', e);
            alert('å…‘æ¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }
    window.redeem = redeem;
</script>

</body>
</html>
