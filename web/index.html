<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Quest - å°å­¦ç”Ÿä½œä¸šç§¯åˆ†ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --accent-color: #FFC107;
            --danger-color: #f44336;
            --text-color: #333;
            --bg-color: #f5f5f5;
            --card-bg: #fff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            width: 100%;
            padding: 1rem 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container {
            width: 90%;
            max-width: 800px;
            margin: 20px auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .role-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .role-btn {
            padding: 10px 30px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1.1rem;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .role-btn.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .points-display {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin: 10px 0;
        }

        .task-list {
            list-style: none;
            padding: 0;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
        }

        .task-points {
            color: var(--primary-color);
            font-weight: bold;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-approved { background-color: #d4edda; color: #155724; }
        .status-todo { background-color: #e2e3e5; color: #383d41; }

        .hidden { display: none; }

        input, select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

<header>
    <h1>Study Quest ğŸ“š</h1>
</header>

<div class="container">
    <div class="role-switcher">
        <button class="role-btn active" onclick="switchRole('student', event)">æˆ‘æ˜¯å­¦ç”Ÿ ğŸ‘¦</button>
        <button class="role-btn" onclick="switchRole('parent', event)">æˆ‘æ˜¯å®¶é•¿ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</button>
    </div>

    <!-- Student View -->
    <div id="student-view">
        <div class="card">
            <h2>æˆ‘çš„ç§¯åˆ† ğŸŒŸ</h2>
            <div class="points-display" id="student-points">0</div>
        </div>

        <div class="card">
            <h2>ä»Šæ—¥ä»»åŠ¡ ğŸ“</h2>
            <ul class="task-list" id="student-task-list">
            </ul>
        </div>

        <div class="card">
            <h2>ç§¯åˆ†å…‘æ¢ ğŸ</h2>
            <ul class="task-list" id="reward-list">
            </ul>
        </div>
    </div>

    <!-- Parent View -->
    <div id="parent-view" class="hidden">
        <div class="card">
            <h2>å¾…å®¡æ ¸ä»»åŠ¡ âœ…</h2>
            <ul class="task-list" id="parent-audit-list">
            </ul>
        </div>

        <div class="card">
            <h2>å‘å¸ƒæ–°ä»»åŠ¡ â•</h2>
            <input type="text" id="new-task-title" placeholder="ä»»åŠ¡åç§° (ä¾‹å¦‚: å®Œæˆæ•°å­¦å·å­)">
            <input type="number" id="new-task-points" placeholder="ç§¯åˆ†å€¼ (ä¾‹å¦‚: 50)">
            <button class="btn btn-primary" onclick="createTask()">å‘å¸ƒä»»åŠ¡</button>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api/v1';
    let currentRole = 'student';

    function switchRole(role, event) {
        currentRole = role;
        document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        if (role === 'student') {
            document.getElementById('student-view').classList.remove('hidden');
            document.getElementById('parent-view').classList.add('hidden');
            loadStudentData();
        } else {
            document.getElementById('student-view').classList.add('hidden');
            document.getElementById('parent-view').classList.remove('hidden');
            loadParentData();
        }
    }

    async function loadStudentData() {
        try {
            const profileRes = await fetch(`${API_BASE}/profile`);
            const profile = await profileRes.json();
            document.getElementById('student-points').innerText = profile.points;

            const tasksRes = await fetch(`${API_BASE}/tasks/today`);
            const tasks = await tasksRes.json();
            renderStudentTasks(tasks);

            renderRewards([
                {id: 1, title: 'çœ‹ç”µè§† 30åˆ†é’Ÿ', cost: 50},
                {id: 2, title: 'ç©æ‰‹æœº 15åˆ†é’Ÿ', cost: 30}
            ]);
        } catch (e) {
            console.error("Failed to load data", e);
        }
    }

    async function loadParentData() {
        try {
            const res = await fetch(`${API_BASE}/tasks/pending`);
            const tasks = await res.json();
            renderParentAuditList(tasks);
        } catch (e) {
            console.error("Failed to load parent data", e);
        }
    }

    function renderStudentTasks(tasks) {
        const list = document.getElementById('student-task-list');
        list.innerHTML = '';
        if (tasks.length === 0) {
            list.innerHTML = '<li class="task-item">æš‚æ— ä»»åŠ¡</li>';
            return;
        }
        tasks.forEach(task => {
            const li = document.createElement('li');
            li.className = 'task-item';
            
            let actionBtn = '';
            if (task.status === 0) {
                actionBtn = `<button class="btn btn-primary" onclick="submitTask(${task.ID})">æäº¤å®Œæˆ</button>`;
            } else if (task.status === 1) {
                actionBtn = `<span class="status-badge status-pending">å®¡æ ¸ä¸­...</span>`;
            } else if (task.status === 2) {
                actionBtn = `<span class="status-badge status-approved">å·²å®Œæˆ</span>`;
            }

            li.innerHTML = `
                <div class="task-info">
                    <h3>${task.task.title}</h3>
                    <span class="task-points">+${task.task.points} ç§¯åˆ†</span>
                </div>
                <div>${actionBtn}</div>
            `;
            list.appendChild(li);
        });
    }

    function renderRewards(rewards) {
        const list = document.getElementById('reward-list');
        list.innerHTML = '';
        rewards.forEach(item => {
            const li = document.createElement('li');
            li.className = 'task-item';
            li.innerHTML = `
                <div class="task-info">
                    <h3>${item.title}</h3>
                    <span class="task-points" style="color:orange">-${item.cost} ç§¯åˆ†</span>
                </div>
                <button class="btn btn-success" onclick="redeem(${item.id})">å…‘æ¢</button>
            `;
            list.appendChild(li);
        });
    }

    function renderParentAuditList(tasks) {
        const list = document.getElementById('parent-audit-list');
        list.innerHTML = '';
        if (tasks.length === 0) {
            list.innerHTML = '<li class="task-item">æš‚æ— å¾…å®¡æ ¸ä»»åŠ¡</li>';
            return;
        }
        tasks.forEach(task => {
            const li = document.createElement('li');
            li.className = 'task-item';
            li.innerHTML = `
                <div class="task-info">
                    <h3>${task.task.title}</h3>
                    <span class="task-points">å¾…å‘: ${task.task.points} ç§¯åˆ†</span>
                </div>
                <div>
                    <button class="btn btn-success" onclick="approveTask(${task.ID}, true)">é€šè¿‡</button>
                    <button class="btn btn-danger" onclick="approveTask(${task.ID}, false)">é©³å›</button>
                </div>
            `;
            list.appendChild(li);
        });
    }

    async function submitTask(taskId) {
        await fetch(`${API_BASE}/tasks/submit`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({task_id: taskId})
        });
        loadStudentData();
    }

    async function approveTask(logId, approved) {
        await fetch(`${API_BASE}/tasks/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({log_id: logId, action: approved ? 'approve' : 'reject'})
        });
        loadParentData();
    }

    async function createTask() {
        const title = document.getElementById('new-task-title').value;
        const points = parseInt(document.getElementById('new-task-points').value);
        if (!title || !points) return alert('è¯·å¡«å†™å®Œæ•´');

        await fetch(`${API_BASE}/tasks/create`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title, points})
        });
        alert('å‘å¸ƒæˆåŠŸ');
        document.getElementById('new-task-title').value = '';
        document.getElementById('new-task-points').value = '';
    }

    async function redeem(id) {
        alert('å…‘æ¢æˆåŠŸï¼è¯·æ‰¾å®¶é•¿é¢†å–å¥–åŠ±ã€‚');
    }

    // Init
    loadStudentData();
</script>

</body>
</html>

